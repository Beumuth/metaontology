<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Instances</title>
    <script type="text/javascript" src="metaontology.js"></script>
    <script type="text/javascript">
        Controller = M.Module.of((
            instanceToListItem=instance=>`<li class='instanceItem'>${M.Instance.toHTML(instance)}</li>`,
            printInstances = instances => document.querySelector("#instanceBrowser .instances").innerHTML =
                instances.map(instanceToListItem).join(""),
            clickTempElement = element => {
                element.style.display = "none";
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);}
        ) => ({
            printAllNodes: () => printInstances(M.Element.allNodes()),
            printInstances: printInstances,
            filterOnClick: () => M.Module.of((
                query = document.querySelector('#filter').value.trim()
            ) => printInstances(query.startsWith("[") ?
                M.Module.of((
                    id=Number.parseInt(query.substr(1, query.indexOf("]")))
                ) => M.Element.exists(id) ? [id] : []) :
                M.Instance.withName(query))),
            createNodeOnClick: () => printInstances([M.Instance.new()]),
            saveOnClick: () => M.Element.saveToLocalStorage(),
            downloadOnClick: () => {
                //Convert the shapes to a text string and open in a new tab
                const tempLink = document.createElement('a');
                tempLink.setAttribute(
                    'href',
                    'data:text/plain;charset=utf-8,' +
                    encodeURIComponent(M.Element.elementsToString(M.Element.all)));
                tempLink.setAttribute('download', "elements.txt");
                clickTempElement(tempLink);},
            importOnClick: uploadCompleteListener => {
                const fileInput = document.createElement("input");
                fileInput.type = "file";
                fileInput.accept = ".txt";
                fileInput.multiple = true;
                fileInput.onchange = () => M.Module.of((
                    files=fileInput.files,
                    numLoaded=0,
                    elements=[],
                    fileReader = new FileReader(),
                    readNext=()=>fileReader.readAsText(files[numLoaded])
                ) => {
                    fileReader.addEventListener('loadend', e => {
                        elements.push(...M.Element
                            .elementsFromString(e.target.result)
                            .filter(element => ! M.Element.exists(element[0])));
                        console.log(M.Element
                            .elementsFromString(e.target.result));
                        if(++numLoaded===files.length) {
                            M.Element.all.push(...elements);
                            M.Element.saveToLocalStorage();
                            uploadCompleteListener();}
                        else {
                            readNext();}});
                    readNext();});
                clickTempElement(fileInput);},
            toggleInstanceDetails: instanceElement => {
                const instanceDetails = instanceElement.querySelector('.instanceDetails');
                const expander = instanceElement.querySelector(".instanceDetailsExpander");
                if(instanceDetails.dataset.expanded !== 'true') {
                    instanceDetails.dataset.expanded = "true";
                    expander.textContent = '-';
                } else {
                    instanceDetails.dataset.expanded = "false";
                    expander.textContent = '+';}},
            tagOnClick: (from, toInput) => {
                document
                    .querySelector(`.instance[data-id='${from}'] .instances`)
                    .insertAdjacentHTML("beforeend",
                        instanceToListItem(M.Instance.tagWith(from, Number.parseInt(toInput.value))));
                toInput.value = "";},
            renameInstance: (id, nameInput) => {
                M.Instance.rename(id, nameInput.value.trim());
                nameInput.value = null;
                nameInput.closest(".instance").querySelector(".instanceName").textContent = M.Instance.nameOf(id);},
            deleteOnClick: id => M.Instance.isUnreferenced(id) ?
                confirm(`Are you sure you want to delete Instance ${M.Instance.nameOf(id)}`) === true ?
                    (
                        M.Instance.delete(id),
                        document.querySelector(`.instance[data-id='${id}']`).remove()
                    ) :
                    undefined :
                alert(`Instance ${M.Instance.nameOf(id)} cannot be deleted due to being referenced`)}));
    </script>
    <style>
        body {
            background-color: #0e0e17;
            color: #D0D0D0;}

        h1 {
            margin-bottom: 5px; }

        ul {
            list-style: none;
            margin: 0;
            padding: 0;}

        nav {
            background-color: #303030;
            border: solid 1px black;
            padding-left: 2px;
            padding-bottom: 2px;}

        ol {
            list-style: none;
            margin: 0;
            padding: 0;}

        .noselect {
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* Safari */
            -khtml-user-select: none; /* Konqueror HTML */
            -moz-user-select: none; /* Old versions of Firefox */
            -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version, currently
                                  supported by Chrome, Edge, Opera and Firefox */}

        .instanceHeader {
            cursor: pointer;
            display: inline-block;}

        .instanceDetails {
            margin-left: 15px;}

        .instanceDetails:not([data-expanded='true']) {
            display: none;}

        .instanceDetailsExpander {
            display: inline-block;
            width: 10px;}

        .instanceLineage {
            display: inline-block; }

        .instanceLineage li {
            display: inline;}

        .instanceLineage li:not(:last-child):after {
            content: " < "}
    </style>
</head>
<body onload="Controller.printAllNodes();">
    <div id="instanceBrowser">
        <h1>Instance Browser</h1>
        <div id="actionsRow">
            <button id="createNode" onclick="Controller.createNodeOnClick();">New</button>
            <button id="save" onclick="Controller.saveOnClick();">Save</button>
            <button id="import" onclick="Controller.importOnClick(Controller.printAllNodes);">Import</button>
            <button id="download" onclick="Controller.downloadOnClick();">Download</button>
        </div>
        <div id="filterContainer">
            <input id="filter" type="text" name="filter">
            <button type="button" onclick="Controller.filterOnClick();">
                Filter
            </button>
        </div>
        <ul class="instances">

        </ul>
    </div>
</body>
</html>